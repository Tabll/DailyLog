# 2019-8-12 周一
## 环境配置
```
PHPStorm
.NET Frameworks 4.7.1
SourceTree
XAMPP
Postman
```
## Apache 配置文件
### httpd.conf
需要更换目录

```
DocumentRoot "E:/www/LinhuibaServer/public"
<Directory "E:/www/LinhuibaServer/public">
```


### httpd-vhosts.conf
需要开启虚拟路由

```
<VirtualHost *:80>
ServerName lhb.com
ServerAlias sh.lhb.com sz.lhb.com hz.lhb.com
DocumentRoot "E:/www/LinhuibaServer/public"
DirectoryIndex demo.html index.php
 <Directory "E:/www/LinhuibaServer/public">
    Options +Indexes +FollowSymLinks +ExecCGI
    AllowOverride All
    Order allow,deny
    Allow from all
    Require all granted
 </Directory>
</VirtualHost>
```

## 项目配置文件
需要在 `public` 目录下添加 `.htaccess` 文件

## PHPStorm
- Laravel 插件
- .env files support 插件
- ldeolog 插件
- PHP代码风格设置，导入 `phpstorm.codestyle.xml`
- Composer 全局安装 `PHP CodeSniffer`
   ```
   composer global require "squizlabs/php_codesniffer=*"
   ```
- PHP 代码质量设置中选择 `Code Sniffer` 配置到本地文件路径：`C:\Users\Administrator\AppData\Roaming\Composer\vendor\bin\phpcs.bat`
-  勾选 Editor > Inspections > PHP > Quality Tools > PHP Code Sniffer Validation，`Coding standard` 选 `PSR2`”` 标准

# 2019-8-13 周二
## 请求筛选
```php
    'task_attachments' => 'array|max:5',
    'task_attachments.*.name' => array(
        'required',
        'regex:/\.(png|jpg|jpeg|bmp|gif|pdf|xls|xlsx|doc|docx|ppt|pptx)$/'
    ),
```
PHP的正则表达式需要在两边套上 `/`

## 数据库查询
```php
    ->when($taskListParameter->finish_to, function ($query) use ($taskListParameter) {
        $query->whereDate('tasks.updated_at', '<=', $taskListParameter->finish_to)
            ->where('tasks.status', '=', Task::TASK_STATUS_FINISHED);
    })
```
在这里使用定义的值：`Task::TASK_STATUS_FINISHED`，而不是 `3`

# 2019-8-14 周三

## 数据库查询日志
```php
    ->when($taskListParameter->finish_from && $taskListParameter->finish_to, function ($query) use ($taskListParameter) {
        \DB::enableQueryLog();
        $query->whereHas('task_histories', function ($query) use ($taskListParameter) {
            $query->where(
                [
                    'task_histories.modified' => 'status',
                    'task_histories.new_value' => Task::TASK_STATUS_FINISHED
                ])
                ->whereDate('task_histories.updated_at', '>=', $taskListParameter->finish_from)
                ->whereDate('task_histories.updated_at', '<=', $taskListParameter->finish_to);
        })->get();
        print_r(\DB::getQueryLog());die();
    })
```
输出数据库执行查询的语句需要用

`\DB::enableQueryLog();`  
$query(***)`->get();`  
`print_r(\DB::getQueryLog());`  
`die();`  
以上查询的输出案例：
```php
Array
(
[0] => Array
(
[query] => select * from `tasks` where exists (select * from `task_histories` where `tasks`.`id` =
`task_histories`.`task_id` and (`task_histories`.`modified` = ? and `task_histories`.`new_value` = ?) and
date(`task_histories`.`updated_at`) >= ? and date(`task_histories`.`updated_at`) <= ? and `task_histories`.`deleted_at`
	is null) and `tasks`.`deleted_at` is null [bindings]=> Array
	(
	[0] => status
	[1] => 3
	[2] => 2018-07-1
	[3] => 2018-07-5
	)

	[time] => 41.95
	)

	)
```
这部分代码最终修改为：
```php
    ->when($taskListParameter->finish_from, function ($query) use ($taskListParameter) {
        $query->whereHas('task_histories', function ($query) use ($taskListParameter) {
            $query->where(
                [
                    'task_histories.modified' => 'status',
                    'task_histories.new_value' => Task::TASK_STATUS_FINISHED
                ]
            )
                ->whereDate('task_histories.updated_at', '>=', $taskListParameter->finish_from);
        });
    })
    ->when($taskListParameter->finish_to, function ($query) use ($taskListParameter) {
        $query->whereHas('task_histories', function ($query) use ($taskListParameter) {
            $query->where(
                [
                    'task_histories.modified' => 'status',
                    'task_histories.new_value' => Task::TASK_STATUS_FINISHED
                ]
            )
                ->whereDate('task_histories.updated_at', '<=', $taskListParameter->finish_to);
        });
    })
```

# 2019-8-15 周四

培训一天

数据库迁移文件的建立：
```
php artisan make:migration add_is_user_edit_into_attributes
Created Migration: 2019_08_15_093544_add_is_user_edit_into_attributes
```
数据库迁移文件代码：
```php
    public function up()
    {
        Schema::table('attributes', function (Blueprint $table) {
            $table->tinyInteger('is_user_edit')
                ->after('is_filter')
                ->nullable(false)
                ->comment('是否用户填写(0:不需要用户填写,1:需要用户填写)');
        });
    }

    public function down()
    {
        Schema::table('attributes', function (Blueprint $table) {
            $table->dropColumn('is_user_edit');
        });
    }
```

# 2019-8-16 周五

培训一天，新员工入职培训结业->GET

昨天的迁移文件修改为
`2019_08_15_093544_add_is_user_edit_into_attributes.php`
```php
    public function up()
    {
        Schema::table('attributes', function (Blueprint $table) {
            $table->boolean('is_user_edit')
                ->after('is_filter')
                ->default(1)
                ->comment('是否用户填写(0:不需要用户填写,1:需要用户填写)');
        });
    }

    public function down()
    {
        Schema::table('attributes', function (Blueprint $table) {
            $table->dropColumn('is_user_edit');
        });
    }
```
新增迁移文件
`2019_08_16_091903_add_remark_into_attributes.php`
```php
    public function up()
    {
        Schema::table('attributes', function (Blueprint $table) {
            $table->string('remark', 200)
                ->after('hint')
                ->nullable(true)
                ->comment('备注');
        });
    }

    public function down()
    {
        Schema::table('attributes', function (Blueprint $table) {
            $table->dropColumn('remark');
        });
    }
```

# 2019-8-17 周六

对于数据类型设置为boolean即长度为1的tinyint，请求验证这么写：<br>
`'is_user_edit' => 'required|integer|in:0,1',`

判断是否在数组中：
```php
    $timeType = array(1, 2, 3, 4);
    if (!in_array($options[0]['value'], $timeType)) {
        //DO SOMETHING
        return response()->fail(self::ERROR_TIME_TYPE_CODE, self::ERROR_TIME_TYPE_MSG);//返回错误代码和错误信息
    }
```

# 2019-8-19 周一

## 条件请求筛选
```php
'hint' => 'required_if:type,3|required_if:type,4|string|max:32',
```
如上例使用 `required_if` 保证在当 `type` 为 `3/4` 的时候的限制

## 模糊查询
```php
    if ($request->filled('remark')) {//备注模糊查询
        $attributes = $attributes->where(function ($q) use ($request) {
            $q->where('remark', 'like', '%' . escape_like($request->input('remark')) . '%');
        });
    }
```
> 关于 `escape_like` 函数，在这个网站有说明 [Laravel: Escape “LIKE” clause?
](https://stackoverflow.com/questions/22749182/laravel-escape-like-clause)
```php
/**
 * Escape special characters for a LIKE query.
 *
 * @param string $value
 * @param string $char
 *
 * @return string
 */
function escape_like(string $value, string $char = '\\'): string
{
    return str_replace(
        [$char, '%', '_'],
        [$char.$char, $char.'%', $char.'_'],
        $value
    );
}
```
## 缓存

保存缓存 (永久)
```php
Cache::forever('cate:' . $id, $category);
```
删除缓存
```php
Cache::forget('cate:');
```
清空缓存
```php
Cache::flush();
```
> 其它操作可以查看： [缓存的相关文档](https://learnku.com/docs/laravel/5.8/cache/3915)

# 2019-8-20 周二


```php
->when(!is_null($parameter->is_connect_contract), function ($query) use ($parameter) {
    if ($parameter->is_connect_contract == Debit::CONNECT_CONTRACT) {
        $query->join('field_order_items', 'field_order_items.debit_id', '=', 'debits.id')
            ->whereExists(function ($query) {
                $query->select('*')
                    ->from('order_relation_contracts')
                    ->whereRaw('order_relation_contracts.order_item_id = field_order_items.id')
                    ->whereIn('order_relation_contracts.contract_type', [
                        'contractPur', 'contractSup', 'contractNor'
                    ]);
            });
    } elseif ($parameter->is_connect_contract == Debit::NOT_CONNECT_CONTRACT) {
        $query->join('field_order_items', 'field_order_items.debit_id', '=', 'debits.id')
            ->whereExists(function ($query) {
                $query->select('*')
                    ->from('order_relation_contracts')
                    ->whereRaw('order_relation_contracts.order_item_id <> field_order_items.id');
            });
    } else {
        die();
    }
})
```

以上语句实际执行情况如下：
```php
Array
(
[0] => Array
(
[query] => select debits.* from `debits` inner join `field_order_items` on `field_order_items`.`debit_id` =
`debits`.`id` where exists (select * from `order_relation_contracts` where order_relation_contracts.order_item_id =
field_order_items.id and `order_relation_contracts`.`contract_type` in (?, ?, ?)) and `debits`.`deleted_at` is null
[bindings] => Array
(
[0] => contractPur
[1] => contractSup
[2] => contractNor
)

[time] => 14.15
)

)
```

# 2019-8-21 周三

## 迁移相关  
迁移文件对应在“laravel/database/migrations”目录下  
迁移执行使用artisan命令，artisan命令需要在Laravel框架的根目录下执行

### 数据库配置  
对数据库账号的配置在“config/database.php”和“laravel/.env”文件中，一般主要修改.env文件中的设置，它的优先级更高。
### 迁移文件的建立  
使用artisan命令创建迁移文件，命令为：  
	`php artisan make:migration create_tableName_table`  
创建好后的迁移文件中包含两个方法：
> Up()：执行命令时创建的表结构  
> Down()：执行回滚时删除的表结构

# 2019-8-22 周四

主要是看需求文档和理解财务相关的操作

# 2019-8-23 周五

## 单元测试
```php
    public function indexDataProvider()
    {
        $case_one = [
            'is_mine' => 1,
            'user_name' => '测试非',
            'order_num' => '152566060848571011',
            'status' => 2,
            'task_type_id' => 4,
            'create_from' => '2018-01-01',
            'create_to' => '2019-02-01',
            'description' => '测试',
        ];
        //此处省略
        $case_five = [
            'finish_from' => '2018-07-1',
            'finish_to' => '2018-07-5',
        ];

        return [
            $case_one, $case_two, $case_three, $case_four, $case_five
        ];
    }
```

```php
/**
 * 保存工单
 *
 * @dataProvider storeDataProvider
 */
public function testStore($parameters)
{
    $dispatcher = app('Dingo\Api\Dispatcher');
    $response = $dispatcher->version('v1')->header('x-client', 'bc')->header('x-client-version', '3.15.2')
        ->post('inner/tasks', $parameters);

    $this->prettyPrint($response);
    $this->assertArraySubset(['code' => 1], $response);
}
```