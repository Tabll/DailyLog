# 2019-8-14
代码删除
#### 文件 `E:\www\LinhuibaServer\app\Http\Controllers\Api\Inner\V1\AttributeController.php`
常量删除
```php
//    const REPEAT_NAME_CODE = -101;
//    const REPEAT_NAME_MSG = '同类型,名称重复';
```

`store` 方法中
```php
//        属性名称重复性检查
//        $acount = Attribute::where('type', $type)
//            ->where('name', $name)
//            ->count();
//        if ($acount) {
//            return response()->fail(self::REPEAT_NAME_CODE, self::REPEAT_NAME_MSG);
//        }
```
`update` 方法中
```php
//        名称重复性检查
//        $acount = Attribute::where('type', $type)
//            ->where('name', $name)
//            ->where('id', '<>', $id)
//            ->count();
//        if ($acount) {
//            return response()->fail(self::REPEAT_NAME_CODE, self::REPEAT_NAME_MSG);
//        }
```

可能是误删除后恢复
文件 `app/Services/OrderService.php`
```php
//       'field_follower' => function ($q) {
//           $q->select('id', 'name', 'mobile');
//       },
```

迁移文件 `2019_08_27_105937_add_pre_invoice_status_into_field_order_items.php`
```php
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddPreInvoiceStatusIntoFieldOrderItems extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('field_order_items', function (Blueprint $table) {
            $table->boolean('pre_invoice_status')
                ->after('invoice_status')
                ->default(0)
                ->comment('预开票(0:没有预开票,1:已预开票)');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('field_order_items', function (Blueprint $table) {
            $table->dropColumn('pre_invoice_status');
        });
    }
}

```

`app\Http\Controllers\Api\Inner\V1\OrderItemController.php` LINE `2613`
```php
//  对于已开票的订单，取消需要财务作废发票
//  if ($orderItem->invoice_status == FieldOrderItem::INVOICE_STATUS_ISSUE) {
//      $orderItem->status = FieldOrderItem::ORDER_STATUS_WAIT_FINANCIAL_CANCELED;
//      $orderItem->save();
//  }
```

`app\Http\Controllers\Api\Inner\V1\OrderItemController.php` LINE `1872`
```php
->when($request->filled('deposit_type'), function ($query) use ($deposit_type) {
    if ($deposit_type == 0) {
        $query->where(function ($query) {
            $query->where('deposit', '>', 0)
                ->orWhere('expense_deposit', '>', 0);
        });
    } elseif ($deposit_type == 1) {
        $query->where('deposit', '>', 0);
    } else {
        $query->where('expense_deposit', '>', 0);
    }
})
->when($request->filled('deposit_status'), function ($query) use ($deposit_status) {
    $query->where('deposit_status', $deposit_status);
})
->when($request->filled('expense_deposit_status'), function ($query) use ($expense_deposit_status) {
    $query->where('expense_deposit_status', $expense_deposit_status);
})
```

# 待办

- [ ] PHP错误与异常 https://segmentfault.com/a/1190000009504337  
- [ ] Laravel消息队列 https://learnku.com/articles/4169/analysis-of-laravel-message-queue
- [ ] Trait https://www.php.net/manual/zh/language.oop5.traits.php
